# Useful tools for managing the cluster

## 1. Rsync

Rsync is a flexible network and directory synchronization tool. Minimum bandwidth consumption due to the use of the 
algorithm to minimize the amount of copied data by moving the changed parts of the file and compressing the files 
at the source and destination while sending and receiving data.
It is faster than the SCP (Secure Copy) command, because by using the remote-update protocol,

```shell
# installation
sudo apt install rsync

# general syntax
rsync <options> <src> <user>@<host>:<dest>
# use rsync to sync conf files between servers
```

### 1.1 Some popular options:
1. (-a, --archive):	This option is used to activate archive mode, transfer specific devices, block devices, recursive 
synchronization of directories, and maintain groups, ownership, and symbolic links.
2. (-P, --partial --progress):	This option runs to view the progress bar while transferring files.
3. (-z, --compress):	This option is used to compress data when transferring to the destination device.
4. (-q, --quiet):	are executed to suppress non-error messages.
5. (--delete):	By running this option, the rsync command will delete additional files from the destination.
6. (-e): to select a different remote shell from the default remote shell rsync(ssh) is executed.
7. (-r): used to copy data recursively.
8. (-v, --verbose):	Provides visual output to view the progress of the process.
9. (-h, --human-readable): provides human-readable format.

### 1.2 Some examples

**The source and destination server must both have rsync installed**

```shell
# sync a local file to destination server
rsync -a ~/test1 username@remote_host:destination_directory

# sync remote file to local 
rsync -a username@remote_host:/home/username/test1 place_to_sync_on_local_machine

# rsync uses ssh to transfer data, if the ssh port is not 22, you need to specify it
# in below example, the destination server ssh port is on 2322
rsync -a -e "ssh -p 2322" test1 remote_user@remote_host_or_ip: destination_directory

## compress the data during sync
rsync -azvP
```

> test1 can be a file or directory, if it's a directory and contains the subdirectory, you need to add -r option

### 1.3. Write a xsync script to distribute conf file on workers

```shell
#!/bin/bash

# check arg numbers
if [ $# -lt 1 ]
then 
  echo Not enough Argument
  exit;
fi 

# 2. loop through host list
for host in spark-w01 spark-w02
do 
  echo =========================== $host ==============================
  
  # 3. loop through the give file list, sync it one by one
  for file in $@
  do
     # 4. check if the file exists
     if [ -e $file ]
         then
           # 5. get the parent dir
           pdir=$(cd -P $(dirname $file); pwd) 
           # 6. get the filename
           fname=$(basename $file)
           ssh $host "mkdir -p $pdir"
           rsync -av $pdir/$fname $host:$pdir
          else
            echo $file does not exists!
     fi 
  done
done 
```


## 3. Setting up Time Sync on Debian

Correct time setting is essential for the proper functioning of modern software. Poor time synchronization across 
systems leads to various issues, from simple errors to severe data corruption. The following sections explain 
how to set up time synchronization on Debian.

### 3.1: Check Time on Debian

Check the time on the server with the date command:

```shell
date

# output example
Tue 28 May 2024 09:54:04 AM CEST
```

The output shows the current time as well as the current date. The current time in the output is usually in 
Coordinated Universal Time (UTC). UTC is the time at zero degrees longitude and is accepted as a universal timezone.
In the above example, we have `timezone CEST(Central European Summer Time)`.

### 3.2: Set up Timezone

The date command prints the UTC zone by default. However, users sometimes need to change the timezone on Debian, 
which is done with the **timedatectl** command. Take the following steps to change the timezone on Debian:

```shell
# 1. List the available timezones on Debian:
timedatectl list-timezones

# 2. Navigate the output with the Spacebar and b key. 

# 3. Press q to quit

# 4. Change the timezone with the following command:
sudo timedatectl set-timezone <timezone>

# change it to UTC
sudo timedatectl set-timezone UTC

# change it to CEST
sudo timedatectl set-timezone Europe/Paris

# 5. Verify the change with date:
date
# you should see now the timezone is UTC or CEST
```

### 3.3: Check The Status of ntpd daemon

Debian runs the standard Network Time Protocol daemon (ntpd) to sync the system time with external time-servers. 
While NTP is the protocol for synchronizing time.

In old version of debian, `ntpd` is the program which implements the NTP protocol.
In recent version, `timesyncd` is used for time sync.

To confirm ntpd is running, execute the systemctl command:

```shell
# show the status of ntpd daemon
sudo systemctl status ntp

# list the time server which the ntpd daemon use to sync time
# The -p argument specifies info about the NTP servers to which ntpd currently connects to.
ntpq -p


```

### 3.4: Switching from ntpd to timesyncd

Normally, you don't need to do this. (**ntpd is replaced by timesyncd by default**).

**Timesyncd** is a `lightweight ntpd alternative`, which is simpler to configure, more efficient, and more secure. 
Furthermore, timesyncd also integrates better with systemd. This feature makes it easy to manage using the systemd commands.

However, **timesyncd cannot be used as a time server**, and it is less sophisticated in keeping the system time in sync. 
These features make the program a less suitable choice for systems in need of accuracy and reliability. 
Complex real-time distributed systems generally work better with ntpd.


```shell
# remove the nptd daemon
sudo apt purge ntp

# install the timesyncd daemon 
sudo apt install systemd-timesyncd

# start the timesyncd service
sudo systemctl start systemd-timesyncd

# check the status
sudo systemctl status systemd-timesyncd

# show the current time
timedatectl

# output example
  Local time: mar. 2024-05-28 10:10:45 CEST
           Universal time: mar. 2024-05-28 08:10:45 UTC 
                 RTC time: mar. 2024-05-28 08:10:44     
                Time zone: Europe/Paris (CEST, +0200)   
System clock synchronized: yes                          
              NTP service: active                       
          RTC in local TZ: no       
```

### 3.5 Configure timesyncd to sync with given timeservers

When starting, systemd-timesyncd will read the configuration file from `/etc/systemd/timesyncd.conf`, which looks like this:

```shell
vim /etc/systemd/timesyncd.conf

# file content
[Time]
#NTP=
#FallbackNTP=0.arch.pool.ntp.org 1.arch.pool.ntp.org 2.arch.pool.ntp.org 3.arch.pool.ntp.org
#...
```

To add time-servers or change the provided ones, uncomment the relevant line and list their `host name or IP` separated 
by a space. Alternatively, you can use a configuration snippet in /etc/systemd/timesyncd.conf.d/*.conf.

In this tutorial, we change it directly in **/etc/systemd/timesyncd.conf**

Below is a basic example of timesyncd.conf

First we configure a main time-server pool.
Then, we configure a fallback time-server pool in case all main time-server are down.

```shell
[Time]
NTP=0.debian.pool.ntp.org 1.debian.pool.ntp.org 2.debian.pool.ntp.org 3.debian.pool.ntp.org
FallbackNTP=0.pool.ntp.org 1.pool.ntp.org 0.fr.pool.ntp.org
```

Save the config file, and restart the service. To verify your configuration:

```shell
timedatectl show-timesync --all

# an output example
LinkNTPServers=
SystemNTPServers=
FallbackNTPServers=ntp.ubuntu.com
ServerName=ntp.ubuntu.com
ServerAddress=91.189.91.157
RootDistanceMaxUSec=5s
PollIntervalMinUSec=32s
PollIntervalMaxUSec=34min 8s
PollIntervalUSec=34min 8s
NTPMessage={ Leap=0, Version=4, Mode=4, Stratum=2, Precision=-24, RootDelay=41.641ms, RootDispersion=900us, Reference=84A36001, OriginateTimestamp=Tue 2024-05-28 10:47:04 CEST, ReceiveTimestamp=Tue 2024-05-28 10:47:04 CEST, TransmitTimestamp=Tue 2024-05-28 10:47:04 CEST, DestinationTimestamp=Tue 2024-05-28 10:47:04 CEST, Ignored=no PacketCount=1500, Jitter=1.508ms }
Frequency=442282
```

**Other possible configuration**:

Further to the daemon configuration, NTP servers may also be provided via a systemd-networkd configuration with a 
NTP= option or, dynamically, via a DHCP server.

**Config overwriting rules**

The NTP server to be used will be determined using the following rules:

1. Any per-interface NTP servers obtained from systemd-networkd.service(8) configuration or via DHCP take precedence.
2. The NTP servers defined in /etc/systemd/timesyncd.conf will be appended to the per-interface list at runtime and 
   the daemon will contact the servers in turn until one is found that responds.
3. If no NTP server information is acquired after completing those steps, the NTP server host names or IP addresses 
    defined in FallbackNTP= will be used.

### 3.6 Use timesyncd

To enable the new conf and start it, simply run:

```shell
# enable ntp server sync
timedatectl set-ntp true

# restart the timesyncd service
systemctl restart systemd-timesyncd

# Check the service status
timedatectl status

# output example
Local time: Thu 2015-07-09 18:21:33 CEST
Universal time: Thu 2015-07-09 16:21:33 UTC
RTC time: Thu 2015-07-09 16:21:33
Time zone: Europe/Amsterdam (CEST, +0200)
System clock synchronized: yes
NTP service: active
RTC in local TZ: no

# get more details of the timesyncd service
timedatectl timesync-status

# To see the non default configuration options set and files from which those options are being derived, use:
systemd-analyze cat-config systemd/timesyncd.conf

# To view the last 24 hours of logged events, use:
journalctl -u systemd-timesyncd --no-hostname --since "1 day ago"
```
> The synchronization process might be noticeably slow. This is expected, one should wait a while before 
determining there is a problem.




